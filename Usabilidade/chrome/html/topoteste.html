<!-- ROTEIRO -->
<div id="USroteiro">
	<b class="USroteiroClose">X</b>
	<h3>Roteiro</h3>
	<p></p>
</div>
<!-- TOPO INSERIDO -->
<div id="USwebclient-topo-todo">
	<div id="USwebclient-topo">
	<div class="USdireita">
		<a class="USbotao USbotao-verde USconcluir USdisabled" id="concluir12qz3" href="#">Concluir</a>
	</div>
	<div class="UScentro" id="roteiroContent">
		<a class="USbotao fancybox" id="roteiro" href="#USroteiro">Roteiro</a>
	</div>
	<div class="USesquerda">
		<a class="USbotao USbotao-info">Bom</a> 
		<a class="USbotao USbotao-vermelho">Ruim</a>
		<a class="USbotao">Comentario</a>
	</div>
	</div>
</div>
<!-- BOTÃO SHOW TOPO -->
<a class="USbotao USbotao-info" id="USbuttonTopo">UseSkill</a>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script>
	var domainUseSkill = "http://localhost:8080/Usabilidade";
	var urlPergunta = "teste/responder/pergunta";
	var urlAtual = location.protocol+location.host+location.pathname;

	//salvar as info armazenadas
	window.onunload = function() {		
		//chrome.extension.sendRequest({useskill: "setNewTab", url: "há :D"});
		//return "nao se va";
	}

	var url = chrome.extension.getURL("js/jquery.js");
	window.jQuery || document.write('<script src="'+url+'"><\/script>');

	
	if(urlAtual.indexOf(urlPergunta)!=-1){
		//é pergunta, esconde o topo
		$('#USwebclient-topo-todo').hide();
		$('#USbuttonTopo').hide();
	}

	(function($){
		var $topo = $('#USwebclient-topo-todo');
		var vel = 400;
		var topoShow = false;
		var animateStoped = true;
		var heightTop = $topo.css("height").substr(0,2);
		var btnConcluir = "concluir12qz3";

		function getStorage(callback){			
			chrome.extension.sendRequest({useskill: "getStorage"}, function(response) {
				if (callback && typeof(callback) === "function") {
        			callback.call(this, response);
    			}
    			
			});
		}

		/*função para topo*/
		$('#USbuttonTopo').live({
			'click':function(e){
				e.preventDefault();
				var $this = $(this);
				if(topoShow){
					$topo.fadeToggle(vel, function(){
						$this.animate({
							top: '-='+heightTop
						},vel/2);
					});
					$this.html('UseSkill');
					topoShow=false;
				}else{
					$this.animate({
						top: '+='+heightTop
					},vel/2,function(){
						$topo.fadeToggle(vel);
					});
					$this.html('Minimizar');
					topoShow=true;
				}
			}
		});

		/*converter json to object*/
		function parseJSON(data) {
	    	return window.JSON && window.JSON.parse ? window.JSON.parse( data ) : (new Function("return " + data))(); 
		}

		/*método genérico para realizar ajax*/
		function ajax(caminho, tipo, dados){
			var retorno;
			$.ajax({
				url: caminho,
				cache: false,
				type: tipo,
				async: false,
				data: dados,
				success: function(dados){
					retorno = dados;
				},
				error: function(jqXHR, status, err){
					console.log(jqXHR);
				}
			});
			return retorno;
		}

		function nextElement(){
			getStorage(function(dado){
				var prox = dado.dados.elementoAtualLista;
				prox++;
				//var listaElementos = parseJSON(dado.dados.listaElementos);
				//var proxEl = listaElementos[prox];
				chrome.extension.sendRequest({useskill: "nextElement", atual: prox});
			});
			//ajax(domainUseSkill+"/tarefa/save/fluxo", "POST", "{ tarefaId: "++", dados: }");
		}

		$(document).ready(function(){
				//iniciar fancybox e o plugin capt
				$('.fancybox').fancybox();

				//quando houver click, verifico se há target e se este é diferente de self e _self (abrindo nova aba).
				$('a').click(function(e){
					var target = $(this).attr("target");
					if(target){
						if(target!="_self" && target!="self"){
							e.preventDefault();
							var href = new String($(this).attr("href"));
							var urlFinal;
							//corrigir url
							//se tiver o :// ta 100%
							if(href.indexOf("://")!=-1){
								urlFinal = href;
							}else{
								//senão tem q verificar se o primeiro elemento da string é o /
								if(href[0]=="/"){
									//path absoluto
									urlFinal=location.protocol+location.host+href;
								}else{
									//senão ele é um path relativo
									urlFinal=location.protocol+location.host+location.pathname+href;
								}
							}
							//open new tab, enviar para plugin nova tab a ser monitorada
							chrome.extension.sendRequest({useskill: "setNewTab", url: urlFinal});
						}
					}
				});

				//ação de fechar roteiro
				$('.USroteiroClose').click(function(e){
					e.preventDefault();
					$('.fancybox-close').trigger('click')
				});

				$("#"+btnConcluir).click(function(e){
					e.preventDefault();
					nextElement();
				});

				$('#USperguntaTeste12z3').click(function(e){
					e.preventDefault();
					nextElement();
					//salvar a pergunta
					//ajax(domainUseSkill+"/tarefa/save/fluxo", "POST", "{ tarefaId: "++", dados: }");
				});

				//$.webclientCapt({'url': "${pageContext.request.contextPath}/tarefa/save/fluxo/usuario"});
				
				$('#roteiro').click(function(e){
					getStorage(function(dado){
						var atual = dado.dados.elementoAtualLista;
						var listaElementos = parseJSON(dado.dados.listaElementos);
						var elAtual = listaElementos[atual];
						$.ajax({
							url : domainUseSkill+"/tarefa/roteiro",
							type : 'POST',
							dataType : 'json',
							async : false,
							data : {
								'idTarefa' : elAtual.id
								},
							success : function(json) {
								$('#USroteiro').children('p').html(json.string);
							},
							error : function(jqXHR, textStatus, errorThrown){
								console.log(jqXHR);
							}
						});
					});
				});
			});
	})(jQuery);
</script>