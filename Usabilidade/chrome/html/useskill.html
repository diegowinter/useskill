<div id="USpluginChrome" class="UseSkill-nocapt UShidden">
	<div id="USleftMenu" >
		<div id="UStestTitle">
			UseSkill - Tarefa
			<span id="USinfoPassos"></span>
			<a class="USpull-right" id="USleftmenuMinimize" href="#"><b class="USicon-minus"></b></a>
		</div>
		<div id="UScontent">
			<div class="USsection" id="USroteiroSection">
				<h1>
					Roteiro
					<!--<a class="USbotao USpull-right" id="USroteiroFull" href="#"></a>-->
					<a class="USbotao USpull-right" id="USroteiroRefresh" href="#"><b class="USicon-refresh"></b></a>
				</h1>
				<div id="USroteiro" class="USsectionContent">

				</div>
			</div>
			<div class="USsection" id="USacoesSection">
				<h1>A&ccedil;&otilde;es</h1>
				<div class="USsectionContent UStext-center">
					<a class="USbotao" id="USadiarTeste" href="#"><b class="USicon-remove-sign"></b> Adiar Teste</a>
					<a class="USbotao" id="USpularTarefa" href="#"><b class="USicon-question-sign"></b> Pular Tarefa</a>
					<a class="USbotao USbotao-info" id="USconcluirTarefa" href="#"><b class="USicon-ok-sign USicon-white"></b> Concluir Tarefa</a>
				</div>
				<div class="USjustificativa UShidden">
					<h2>Justificativa - <span></span></h2>
					<div class="USsectionContent UStext-right ">
						<textarea id="USjustificativaAcao" name="USjustificativaAcao"></textarea>

						<a class="USbotao UScancelarAcao" href="#">Cancelar</a>
						<a class="USbotao USbotao-info" id="USacoesProsseguir" href="#">Prosseguir</a>
					</div>
				</div>
			</div>
			<div class="USsection" id="UScomentarioSection">
				<h1>Coment&aacute;rios</h1>
				<div id="UScomentarioSubSection" class="USsectionContent UStext-center">
					<a class="USbotao width100" id="USrealizarComentario" href="#"><b class="USicon-comment"></b> Realizar Coment&aacute;rio</a>
				</div>
				<div id="UScomentarioEtapa1" class="UShidden">
					<h2>Qualifique seu comentário:</h2>
					<div class="USsectionContent UStext-right ">
						<a class="USbotao UScancelarComentario" href="#">Cancelar</a>
						<a class="USbotao USbotao-vermelho UScomentarioQualifique" data-type="false" href="#"><b class="USicon-thumbs-down USicon-white"></b></a>
						<a class="USbotao USbotao-verde UScomentarioQualifique" data-type="true" href="#"><b class="USicon-thumbs-up USicon-white"></b></a>
					</div>
				</div>
				<div id="UScomentarioEtapa2" class="UShidden">
					<h2>Selecione o motivo do comentário:</h2>
					<div class="USsectionContent UStext-right ">
						<!-- <a class="USbotao" id="UScomentarioSelecionar" href="#"><b class="USicon-fullscreen"></b>Selecionar Área</a> -->
						<a class="USbotao UScancelarComentario" href="#">Cancelar</a>
						<a class="USbotao USbotao-info" id="UScomentarioMotivoProsseguir" href="#">Prosseguir</a>

						<canvas id="canvasClone"></canvas>
					</div>
				</div>
				<div id="UScomentarioEtapa3" class="UShidden">
					<h2>Coment&aacute;rio:</h2>
					<div class="USsectionContent UStext-right">
						<textarea id="UScomentarioTexto" name="UScomentarioTexto"></textarea>

						<a class="USbotao UScancelarComentario" href="#">Cancelar</a>
						<a class="USbotao USbotao-info" id="UScomentarioEnviar" href="#">Enviar</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="USbuttonResize" class="USbuttonResize">
		<b class="USicon-resize-full USicon-white"></b>
	</div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script type="text/javascript">
	/*Inserindo imagens ao css*/
	var urlImg = chrome.extension.getURL("images/glyphicons-halflings.png");
	var urlImg2 = chrome.extension.getURL("images/glyphicons-halflings-white.png");
	$('[class*="USicon-"]').css("background-image", 'url("'+urlImg+'")');
	$('.USicon-white').css("background-image", 'url("'+urlImg2+'")');

	var enumTypeActions = {
		PULAR:'pular',
		ADIAR:'adiar'
	}
	var enumTypeQualify = {
		GOOD:'true',
		BAD:'false'
	}

	//evitar plugin em perguntas
	var urlPergunta = "teste/responder/pergunta";
	var urlAtual = location.protocol+location.host+location.pathname;
	if(urlAtual.indexOf(urlPergunta)!=-1){
		//fadeOutUS($('#USacoesSection'));
		//fadeOutUS($('#USroteiroSection'));
		fadeOutUS($('#USpluginChrome'));

		//"gambiarra" para corrigir id da pergunta nulo
		var count = localStorage.getItem("countRefresh");
		var idPerg = $('#pergid').val();
		if(!count){
			count = 0;
			localStorage.setItem("countRefresh", count);
		}
		if(count<4){
			if(!idPerg){
				localStorage.setItem("countRefresh", count+1);
				window.location.reload(true);
			}
		}else{
			if(idPerg){
				localStorage.setItem("countRefresh", 0);
			}else{
				console.error("Error: ID null;");
			}

		}
	}

	$(document).ready(function(){
		//ao iniciar, carregar as informacoes do teste atual
		var numElAtual, listaEl, elAtual, acoes, loadEl;
		chrome.extension.sendRequest({useskill: "getStorageAndAcoes"}, function(resp) {
			numElAtual = resp.storage.elementoAtualLista;
			listaEl = parseJSON(resp.storage.listaElementos);
			elAtual = listaEl[numElAtual];
			acoes = stringfyJSON(resp.acoes);
			//apos capturar as variaveis, setar texto em cima
			$("#USinfoPassos").html(numElAtual+1 +"/"+ listaEl.length);
			if(elAtual.tipo=="T"){
				getRoteiro(elAtual.id);
				//se n estiver openned, fecha
				console.log(resp.isOpenned);
				if(!resp.isOpenned){
					hideUSleftMenu();
				}
				$('#USpluginChrome').removeClass('UShidden');
			}
		});

		//Funcoes para comunicacao com o background
		function getStorage(callback){			
			chrome.extension.sendRequest({useskill: "getStorage"}, function(response) {
				if (callback && typeof(callback) === "function") {
        			callback.call(this, response);
    			}
			});
		}
		function setIsOpenned(booleano){
			if(booleano!=null){
				chrome.extension.sendRequest({useskill: "setOpenned", isOpenned: booleano});
			}
		}
		function nextElement(){
			getStorage(function(dado){
				var prox = dado.dados.elementoAtualLista;
				prox++;
				chrome.extension.sendRequest({useskill: "nextElement", atual: prox});
			});
		}
		function getRoteiro(atual){
			chrome.extension.sendRequest({useskillserver: "getRoteiro", idTarefa: atual}, function(response) {
				if(response.dados.string){
					$('#USroteiro').html(response.dados.string);
				}else{
					alertUS("Tente novamente!");
				}
			});
		}
		function concluirTarefa(atual){
			chrome.extension.sendRequest({useskillserver: "concluirTarefa", idTarefa: atual}, function(response) {			
				if(response.success){
					nextElement();
				}else{
					//console.log(response.errorType)
					alertUS("Tente novamente!");
					console.log("erro concluir - not success");
				}
			});
		}
		function pularTarefa(atual, justificativa){
			chrome.extension.sendRequest({useskillserver: "pularTarefa", idTarefa: atual, justificativa: justificativa}, function(response) {	
				if(response.success){
					nextElement();
					acoesReset();
				}else{
					//console.log(response.errorType)
					alertUS("Tente novamente!");
					console.log("erro pular - not success");
				}
			});
		}
		function adiarTeste(justificativa){
			chrome.extension.sendRequest({useskill: "testFinish", justificativa: justificativa}, function(response) {	
				if(response.success){
					nextElement();
					acoesReset();
				}else{
					//console.log(response.errorType)
					alertUS("Tente novamente!");
					console.log("erro pular - not success");
				}
			});
		}
		function enviarComentario(atual, texto, quali){
			chrome.extension.sendRequest({useskillserver: "enviarComentario", idTarefa: atual, texto: texto, quali: quali}, function(response) {	
				if(response.success){
					//nextElement();
					comentarioReset();
				}else{
					//console.log(response.errorType)
					alertUS("Tente novamente!");
					console.log("erro comentar - not success");
				}
			});
		}
		function responderPergunta(atual, resposta, url){
			chrome.extension.sendRequest({useskillserver: "responderPergunta", idPergunta: atual, resposta: resposta, url: url}, function(response) {							
				if(response.success){
					nextElement();
				}else{
					//console.log(response.errorType)
					$('.USAlertError').html('Não foi possível responder. Tente Novamente!');
					$('.alert').fadeIn(300);
					//alertUS("Tente novamente!");
					console.log("erro responderPergunta - not success");
				}
			});
		}
		
		//Eventos JQUERY
		$('#USbuttonResize').on('click', function(e){
			e.preventDefault();
			toogleUSleftMenu();
		});
		$('#USleftmenuMinimize').on('click', function(e){
			e.preventDefault();
			toogleUSleftMenu();
		});
		$('#USroteiroRefresh').on('click', function(e){
			e.preventDefault();
			getRoteiro(elAtual.id);
		});
		//Acoes
		$('#USconcluirTarefa').on('click', function(e){
			e.preventDefault();
			concluirTarefa(elAtual.id);
		});
		$('#USadiarTeste').on('click', function(e){
			e.preventDefault();
			//showUSjustificativa(this, enumTypeActions.ADIAR);
			var msg = $('#USjustificativaAcao').val();
			var r = confirm("Deseja adiar este teste? Os dados armazenado até o momento serão perdidos!");
			if (r==true){
				adiarTeste(msg);
			}
		});
		$('#USpularTarefa').on('click', function(e){
			e.preventDefault();
			showUSjustificativa(this, enumTypeActions.PULAR);
		});
		$('.UScancelarAcao').on('click', function(e){
			e.preventDefault();
			hideUSjustificativa(this);
			acoesReset();
		});
		$('#USacoesProsseguir').on('click', function(e){
			var msg = $('#USjustificativaAcao').val();			
			if(msg!=null && msg!=""){
				e.preventDefault();
				pularTarefa(elAtual.id, msg);
			}else{
				alertUS("Preencha a justificativa!")
			}
		});
		//Comentarios
		$('#USrealizarComentario').on('click', function(e){
			e.preventDefault();
			fadeOutUS($('#UScomentarioSubSection'));
			fadeInUS($('#UScomentarioEtapa1'));
		});
		$('.UScancelarComentario').on('click', function(e){
			e.preventDefault();
			comentarioReset();
		});
		$('.UScomentarioQualifique').on('click', function(e){
			e.preventDefault();
			var quali = $(this).attr('data-type');
			if(quali){
				fadeOutUS($('#UScomentarioEtapa1'));
				fadeInUS($('#UScomentarioEtapa2'));
				$('#UScomentarioEnviar').attr('data-quali', quali);
			}else{
				alertUS('Tente novamente!');
			}
		});
		$('#UScomentarioMotivoProsseguir').on('click', function(e){
			e.preventDefault();
			fadeOutUS($('#UScomentarioEtapa2'));
			fadeInUS($('#UScomentarioEtapa3'));
		});
		$('#UScomentarioEnviar').on('click', function(e){
			e.preventDefault();
			var msg = $('#UScomentarioTexto').val();
			var qualis = $(this).attr('data-quali');
			if(msg!=null && msg!=""){
				e.preventDefault();
				if(qualis){
					enviarComentario(elAtual.id, msg, qualis);
				}else{
					alertUS("Tente novamente!")
				}
			}else{
				alertUS("Preencha seu Comentário!")
			}
		});
		//Questionario
		//metodo para responder questionario
		$('#USperguntaTeste12z3').click(function(e){
			e.preventDefault();
			var $form = $(this).parentsUntil("form").parent();
			var pergId = $form.children("#pergid").val();
			var urlResp = $form.attr('action');
			var resposta = "", respostaVefiry = "";
			//separar resposta
			if(urlResp.indexOf('alternativa')!=-1){
				var $checked = $('input:checked');
				if($checked.length!=0){
					resposta = $checked.val();
					respostaVefiry = $checked.val();
				}
			}else{
				resposta = new String($('textarea').val());
				respostaVefiry = resposta.replace(" ","");
				respostaVefiry = resposta.replace("\n","");
			}
			//evitar problema localhost de duplicar /Usabilidade
			if(respostaVefiry!=""){
				responderPergunta(pergId, resposta, urlResp);
			}else{
				$('.USAlertError').html('Preencha a resposta antes de enviar!');
				$('.alert').fadeIn(300);
			}
		});
		//Canvas
		var jcrop_api, jcrop_coords;
		$('#UScomentarioSelecionar').on('click', function(e){
			e.preventDefault();
			try{
				hideUSleftMenu();
				var target = $('body');
				html2canvas(target, {
		    		onrendered: function(cv) {
		    			fadeInUS($('#jCropSupport'));
		    			var imgSrc = cv.toDataURL();
		    			$('#jCrop').attr('src', imgSrc);
		    			jcrop_api = $.Jcrop('#jCrop');
		    			jcrop_api.setOptions({ onSelect: jcropCoords });
		    		}
				});
			}catch(e){
				removeCrop();
			}
		});
		$('#canvasSelect').on('click', function(e){
			e.preventDefault();
			try{
				var canvas = document.getElementById('myCanvas');
				var canvasClone = document.getElementById('canvasClone');
			    var context = canvas.getContext('2d');
			    var contextClone = canvasClone.getContext('2d');
			    var imageObj = new Image();
			    $(canvas).attr('width', jcrop_coords.w);
			    $(canvas).attr('height', jcrop_coords.h);
			    imageObj.onload = function() {
			        // draw cropped image
			        var sourceX = jcrop_coords.x;
			        var sourceY = jcrop_coords.y;
			        var sourceWidth = jcrop_coords.w;
			        var sourceHeight = jcrop_coords.h;
			        var destWidth = sourceWidth;
			        var destHeight = sourceHeight;
			        var destX = canvas.width / 2 - destWidth / 2;
			        var destY = canvas.height / 2 - destHeight / 2;
			        context.clearRect(0, 0, canvas.width, canvas.height);
			        context.drawImage(imageObj, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
			        contextClone.clearRect(0, 0, canvasClone.width, canvasClone.height);
			        contextClone.drawImage(imageObj, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
			    };
			    imageObj.src = $('#jCrop').attr('src');
			    removeCrop();
			}catch(e){
				removeCrop();
			}
		});
		$('#canvasCancel').on('click', function(e){
			e.preventDefault();
			removeCrop();
		});
		function removeCrop(){
			fadeOutUS($('#jCropSupport'));
			try{
				jcrop_api.destroy();
			}catch(e){ }
			$('#jCrop').attr('src','');
			toogleUSleftMenu();
		}
		function jcropCoords(coords){
			jcrop_coords = coords;
			console.log(jcrop_coords)
		}
		function clearCanvas(){
			var canvas = document.getElementById('myCanvas');
			var canvasClone = document.getElementById('canvasClone');
		    var context = canvas.getContext('2d');
		    var contextClone = canvasClone.getContext('2d');
		    context.clearRect(0, 0, canvas.width, canvas.height);
		    contextClone.clearRect(0, 0, canvasClone.width, canvasClone.height);
		}


		//Animacoes JQUERY
		function toogleUSleftMenu(){
			var $this = $('#USleftMenu');
			
			if($this.css('left')=="0px"){
				setIsOpenned(false);
				$('#USleftMenu').animate({
				    left: '-='+$this.width()
				});
				$('#USbuttonResize').animate({
				    left: '-='+$this.width()
				});
			}else{
				setIsOpenned(true);
				$('#USleftMenu').animate({
				    left: '+='+$this.width()
				});
				$('#USbuttonResize').animate({
				    left: '+='+$this.width()
				});
			}
		}
		function hideUSleftMenu(){
			setIsOpenned(false);
			var w = $('#USleftMenu').width();
			$('#USleftMenu').animate({
			    left: '-='+w
			}, 0);
			$('#USbuttonResize').animate({
			    left: '-='+w
			}, 0);
		}
		function showUSjustificativa(elem, type){
			var $just = $('.USjustificativa').eq(0);
			fadeOutUS($(elem).parent());
			fadeInUS($just);
			$just.find("h2 span").text($(elem).text());
		}
		function hideUSjustificativa(elem){
			var $just = $('.USjustificativa').eq(0);
			var $sec = $(elem).closest('.USsection');
			fadeInUS($sec.find('.UShidden'));
			fadeOutUS($just);
			$just.find("h2 span").text(' ');
		}
		function comentarioReset(){
			fadeOutUS($('#UScomentarioEtapa1'));
			fadeOutUS($('#UScomentarioEtapa2'));
			fadeOutUS($('#UScomentarioEtapa3'));
			fadeInUS($('#UScomentarioSubSection'));
			$('#UScomentarioEnviar').attr('data-quali', '');
			$('#UScomentarioTexto').val("");
			clearCanvas();
		}
		function acoesReset(){
			$('#USjustificativaAcao').val("");
		}
	});

	/*converter json to object*/
	function parseJSON(data) {
    	return window.JSON && window.JSON.parse ? window.JSON.parse( data ) : (new Function("return " + data))(); 
	}
	function stringfyJSON(data){
		return window.JSON && window.JSON.stringify ? window.JSON.stringify(data) : (new Function("return " + data))();
	}
	function alertUS(msg){
		window.alert(msg);
	}
	function fadeInUS($elem){
		$elem.hide().removeClass('UShidden').fadeIn(400);
	}
	function fadeOutUS($elem){
		$elem.addClass('UShidden').fadeOut(400);
	}
</script>

<div id="jCropSupport" class="UseSkill-nocapt UShidden">
	<div class="jCropAbsolute">
		<img id="jCrop" src="" />
		<a id="canvasSelect" class="USbotao USbotao-info jcrop-btn-accept" href="#">Selecionar</a>
		<a id="canvasCancel" class="USbotao jcrop-btn-cancel" href="#">Cancelar</a>
	</div>
	<canvas id="myCanvas"></canvas>
</div>